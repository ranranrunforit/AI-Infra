apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# =============================================================================
# Production Environment Overlay
# Full production configuration with high availability and security
# =============================================================================

# Metadata
metadata:
  name: model-serving-prod
  namespace: production

# Use base configuration
bases:
- ../../base

# Override namespace
namespace: production

# Environment-specific labels
commonLabels:
  environment: production
  deployment-type: production
  tier: critical

# Environment-specific annotations
commonAnnotations:
  environment: production
  monitoring: "critical"
  backup: "enabled"
  compliance: "required"

# Name suffix
nameSuffix: -prod

# =============================================================================
# Image Overrides - Use production image with digest for immutability
# =============================================================================
images:
- name: ai-infra/model-serving
  newName: ai-infra/model-serving
  # Use semantic versioning in production
  newTag: v1.0.0
  # Optionally use digest for maximum reproducibility
  # digest: sha256:abcdef1234567890...

# =============================================================================
# Replica Overrides - High availability
# =============================================================================
replicas:
- name: model-serving
  count: 5

# =============================================================================
# ConfigMap Patches - Production configuration
# =============================================================================
configMapGenerator:
- name: model-serving-config
  behavior: merge
  literals:
  # Server
  - SERVER_LOG_LEVEL=warning  # Reduced logging in production
  - SERVER_WORKERS=4

  # Debugging - Disabled in production
  - DEBUG_MODE=false
  - PROFILE_REQUESTS=false
  - VERBOSE_ERROR_MESSAGES=false
  - SAVE_REQUEST_PAYLOADS=false

  # Tracing - Sample 10% in production
  - OTEL_TRACES_SAMPLER_ARG=0.1

  # Rate limiting - Production limits
  - RATE_LIMIT_ENABLED=true
  - RATE_LIMIT_REQUESTS_PER_MINUTE=10000
  - RATE_LIMIT_BURST=1000

  # Model configuration
  - MAX_MODELS_LOADED=5
  - PRELOAD_MODELS=resnet50-fp16,bert-base-fp16,gpt2-fp16

  # GPU - Maximum utilization
  - GPU_MEMORY_FRACTION=0.90
  - VLLM_GPU_MEMORY_UTILIZATION=0.90

  # Performance - Production optimized
  - ASYNC_WORKERS=4
  - THREAD_POOL_SIZE=8
  - CONNECTION_POOL_SIZE=100

  # Security - Production settings
  - REQUIRE_API_KEY=true
  - ENABLE_CORS=false

  # High availability
  - AUTO_CHECKPOINT_ENABLED=true
  - CHECKPOINT_INTERVAL_SECONDS=3600
  - DISASTER_RECOVERY_ENABLED=true

  # Environment marker
  - ENVIRONMENT=production

# =============================================================================
# Patches - Production-specific modifications
# =============================================================================
patches:
# Patch deployment for production
- target:
    kind: Deployment
    name: model-serving
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: model-serving
      annotations:
        # Notification settings
        notifications.argoproj.io/subscribe.on-deployed.slack: "production-deploys"
        notifications.argoproj.io/subscribe.on-health-degraded.pagerduty: "ml-platform"
    spec:
      # Zero-downtime deployments
      strategy:
        rollingUpdate:
          maxSurge: 2
          maxUnavailable: 0
      template:
        metadata:
          annotations:
            # Enhanced monitoring
            prometheus.io/scrape: "true"
            prometheus.io/port: "9090"
            prometheus.io/path: "/metrics"
        spec:
          # Enhanced pod anti-affinity for production
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                  - key: app
                    operator: In
                    values:
                    - model-serving
                topologyKey: kubernetes.io/hostname
              preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchExpressions:
                    - key: app
                      operator: In
                      values:
                      - model-serving
                  topologyKey: topology.kubernetes.io/zone
          containers:
          - name: model-serving
            # Production resource requirements
            resources:
              requests:
                cpu: "4000m"
                memory: "16Gi"
                nvidia.com/gpu: "1"
              limits:
                cpu: "8000m"
                memory: "32Gi"
                nvidia.com/gpu: "1"
            # Production probe configuration
            startupProbe:
              initialDelaySeconds: 15
              periodSeconds: 10
              timeoutSeconds: 10
              failureThreshold: 30
            livenessProbe:
              initialDelaySeconds: 30
              periodSeconds: 30
              timeoutSeconds: 10
              failureThreshold: 3
            readinessProbe:
              initialDelaySeconds: 20
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 2
            # Enhanced security context
            securityContext:
              allowPrivilegeEscalation: false
              runAsNonRoot: true
              runAsUser: 1000
              readOnlyRootFilesystem: false
              capabilities:
                drop:
                - ALL
          # Priority class for production workloads
          priorityClassName: production-high
          # Longer termination grace period
          terminationGracePeriodSeconds: 120

# Patch HPA for production - Aggressive scaling
- target:
    kind: HorizontalPodAutoscaler
    name: model-serving-hpa
  patch: |-
    apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    metadata:
      name: model-serving-hpa
    spec:
      minReplicas: 5
      maxReplicas: 20
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 60
          policies:
          - type: Pods
            value: 4
            periodSeconds: 60
          - type: Percent
            value: 100
            periodSeconds: 60
          selectPolicy: Max
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
          - type: Pods
            value: 1
            periodSeconds: 60
          - type: Percent
            value: 10
            periodSeconds: 60
          selectPolicy: Min
      metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 70
      - type: Resource
        resource:
          name: memory
          target:
            type: Utilization
            averageUtilization: 80

# Patch PVC for production storage
- target:
    kind: PersistentVolumeClaim
    name: model-cache-pvc
  patch: |-
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: model-cache-pvc
      annotations:
        # Enable backup
        backup.velero.io/backup-volumes: "model-cache"
    spec:
      storageClassName: fast-ssd-retain
      resources:
        requests:
          storage: 500Gi

- target:
    kind: PersistentVolumeClaim
    name: engine-cache-pvc
  patch: |-
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: engine-cache-pvc
      annotations:
        backup.velero.io/backup-volumes: "engine-cache"
    spec:
      storageClassName: fast-ssd-retain
      resources:
        requests:
          storage: 200Gi

# Patch PDB for production high availability
- target:
    kind: PodDisruptionBudget
    name: model-serving-pdb
  patch: |-
    apiVersion: policy/v1
    kind: PodDisruptionBudget
    metadata:
      name: model-serving-pdb
    spec:
      minAvailable: 3
      unhealthyPodEvictionPolicy: IfHealthyBudget

# Patch ServiceMonitor for production
- target:
    kind: ServiceMonitor
    name: model-serving
  patch: |-
    apiVersion: monitoring.coreos.com/v1
    kind: ServiceMonitor
    metadata:
      name: model-serving
    spec:
      endpoints:
      - port: metrics
        interval: 15s
        scrapeTimeout: 10s
        path: /metrics
        metricRelabelings:
        - targetLabel: environment
          replacement: production

# =============================================================================
# Additional Production Resources
# =============================================================================
resources:
- ingress.yaml
- priorityclass.yaml
- network-policy-strict.yaml
