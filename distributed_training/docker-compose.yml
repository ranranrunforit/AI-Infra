version: '3.8'

services:
  ray-head:
    build: .
    image: ray-training-laptop:latest
    container_name: ray-head
    shm_size: '4gb'
    tty: true
    stdin_open: true
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=0
      - RAY_MEMORY_MONITOR_REFRESH_MS=0
      - CUDA_VISIBLE_DEVICES=0
      - OMP_NUM_THREADS=4
      - PYTHONUNBUFFERED=1
      - PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512
      - PYTHONPATH=/app/src
      # Ray logging
      - RAY_LOG_TO_STDERR=1
      - RAY_BACKEND_LOG_LEVEL=warning
    # FIXED: Use bash to start Ray with dashboard properly
    command: >
      bash -c "
      echo 'Starting Ray head node with dashboard...';
      ray start --head
      --port=6379
      --dashboard-host=0.0.0.0
      --dashboard-port=8265
      --num-cpus=8
      --num-gpus=1
      --object-store-memory=2000000000
      --include-dashboard=true
      --disable-usage-stats
      --block
      "
    ports:
      - "6379:6379"      # Ray GCS
      - "8265:8265"      # Ray Dashboard - MAIN FIX
      - "10001:10001"    # Ray Client
      - "8080:8080"      # Prometheus
    volumes:
      - ./data:/mnt/data
      - ./checkpoints:/mnt/checkpoints
      - ./src:/app/src
      - ./logs:/app/logs
    networks:
      - ray-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8265"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  ray-network:
    driver: bridge