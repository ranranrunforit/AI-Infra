apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: trainingjobs.ml.example.com
spec:
  group: ml.example.com
  names:
    kind: TrainingJob
    listKind: TrainingJobList
    plural: trainingjobs
    singular: trainingjob
    shortNames:
      - tj
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - model
                - dataset
                - numWorkers
              properties:
                model:
                  type: string
                  minLength: 1
                dataset:
                  type: string
                  minLength: 1
                numWorkers:
                  type: integer
                  minimum: 1
                  maximum: 100
                gpusPerWorker:
                  type: integer
                  minimum: 0
                  maximum: 16
                  default: 1
                framework:
                  type: string
                  enum: [pytorch, tensorflow, jax]
                  default: pytorch
                image:
                  type: string
                  default: "pytorch/pytorch:2.1.0-cuda11.8-cudnn8-runtime"
                command:
                  type: array
                  items:
                    type: string
                args:
                  type: array
                  items:
                    type: string
                env:
                  type: array
                  items:
                    type: object
                hyperparameters:
                  type: object
                  additionalProperties:
                    type: string
                checkpoint:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: true
                    frequency:
                      type: integer
                      default: 5
                    storage:
                      type: object
                      properties:
                        type:
                          type: string
                          enum: [pvc, s3, gcs, nfs]
                        pvcName:
                          type: string
                scheduling:
                  type: object
                  properties:
                    priority:
                      type: string
                    nodeSelector:
                      type: object
                      additionalProperties:
                        type: string
                monitoring:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: true
                    metricsPort:
                      type: integer
                      default: 8080
                    mlflowTrackingUri:
                      type: string
                    wandbProject:
                      type: string
                networking:
                  type: object
                  properties:
                    backend:
                      type: string
                      default: nccl
                    masterPort:
                      type: integer
                      default: 29500
            status:
              type: object
              properties:
                state:
                  type: string
                  enum: [Pending, Initializing, Running, Completed, Failed, Suspended]
                progress:
                  type: string
                currentEpoch:
                  type: integer
                resources:
                  type: object
                  properties:
                    allocatedGPUs:
                      type: integer
                    allocatedNodes:
                      type: integer
                workers:
                  type: object
                  properties:
                    active:
                      type: integer
                    succeeded:
                      type: integer
                    failed:
                      type: integer
                    pending:
                      type: integer
                startTime:
                  type: string
                  format: date-time
                completionTime:
                  type: string
                  format: date-time
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: State
          type: string
          jsonPath: .status.state
        - name: Progress
          type: string
          jsonPath: .status.progress
        - name: Epoch
          type: integer
          jsonPath: .status.currentEpoch
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
